<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title> إدارة هويات الموظفين</title>

<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
:root{
  --navy:#072a4e;
  --border:#e2e8f0;
  --bg:#f1f5f9;
  --text:#1e293b;
  --muted:#64748b;
}
*{box-sizing:border-box}
body{
  margin:0;
  padding:30px;
  background:var(--bg);
  font-family:Inter,"IBM Plex Sans Arabic",sans-serif;
}
.wrapper{
  max-width:1200px;
  margin:auto;
  display:grid;
  grid-template-columns:360px 1fr;
  gap:30px;
}
.panel{
  background:#fff;
  border:1px solid var(--border);
  border-radius:16px;
  padding:20px;
}
label{
  font-size:12px;
  font-weight:700;
  display:block;
  margin-bottom:4px;
}
input,select{
  width:100%;
  padding:9px 10px;
  margin-bottom:12px;
  border:1px solid var(--border);
  border-radius:10px;
}
button{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:10px;
  border:none;
  font-weight:700;
  cursor:pointer;
}
.btn-primary{background:var(--navy);color:#fff}
.btn-secondary{background:#fff;border:1px solid var(--border);color:var(--navy)}

.notice{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  display:none;
}
.notice.success{background:#dcfce7;color:#166534}
.notice.error{background:#fee2e2;color:#991b1b}

/* Card */
.card{
  width:800px;
  height:520px;
  background:#fff;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 20px 30px rgba(0,0,0,.12);
}
.card-header{
  height:140px;
  background:linear-gradient(135deg,#041c33,#072a4e,#0b3b6d);
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
.company-ar{font-size:26px;font-weight:800}
.company-en{font-size:15px;opacity:.9;direction:ltr}

.card-body{
  padding:16px 36px 80px;
  display:grid;
  grid-template-columns:1fr 200px;
  gap:26px;
}
.emp-name{
  font-size:28px;
  font-weight:800;
  color:var(--navy);
  margin-bottom:14px;
}
.data-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.box{
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 14px;
}
.box.full{grid-column:span 2}
.lbl{font-size:12px;color:var(--muted)}
.val{font-size:18px;font-weight:700}
.val.ltr{direction:ltr}

.photo-area{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}
.photo{
  width:180px;
  height:200px;
  border-radius:14px;
  border:1px solid var(--border);
  overflow:hidden;
  background:#f8fafc;
}
.photo img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:none;
}
#barcode{width:180px;height:48px}
.qr-box{
  width:72px;height:72px;
  border:1px solid var(--border);
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
}
</style>
</head>

<body>
<div class="wrapper">

<!-- ===== CONTROL PANEL ===== -->
<div class="panel">
  <label for="empSelect">اختيار موظف</label>
  <select id="empSelect" onchange="selectEmployee()">
    <option value="">—</option>
  </select>

  <label for="f_name">الاسم الكامل</label>
  <input id="f_name" oninput="livePreview()">

  <label for="f_job">المسمى الوظيفي</label>
  <input id="f_job" oninput="livePreview()">

  <label for="f_dept">القسم</label>
  <input id="f_dept" oninput="livePreview()">

  <label for="f_type">نوع الموظف</label>
  <select id="f_type" onchange="livePreview()">
    <option value="0">خدمي</option>
    <option value="1">إداري</option>
  </select>

  <label for="f_blood">فصيلة الدم</label>
  <select id="f_blood" onchange="livePreview()">
    <option value="">—</option>
    <option>O+</option><option>O-</option>
    <option>A+</option><option>A-</option>
    <option>B+</option><option>B-</option>
    <option>AB+</option><option>AB-</option>
  </select>

  <label for="f_dob">تاريخ التولد</label>
  <input type="date" id="f_dob" onchange="livePreview()">

  <label for="f_exp">تاريخ الصلاحية</label>
  <input type="date" id="f_exp" onchange="livePreview()">

  <label for="f_photo">الصورة الشخصية</label>
  <input type="file" id="f_photo" accept="image/*" onchange="loadPhoto(event)">

  <button class="btn-primary" onclick="addEmployee()">إضافة موظف</button>
  <button class="btn-secondary" onclick="updateEmployee()">تحديث البيانات</button>

  <div id="notice" class="notice"></div>
</div>

<!-- ===== CARD ===== -->
<div class="card">
  <div class="card-header">
    <div class="company-ar">شركة المراسيل للتجارة العامة</div>
    <div class="company-en">Al Maraseel General Trading</div>
  </div>

  <div class="card-body">
    <div>
      <div class="emp-name" id="c_name">—</div>
      <div class="data-grid">
        <div class="box full"><div class="lbl">المسمى الوظيفي</div><div class="val" id="c_job">—</div></div>
        <div class="box"><div class="lbl">القسم</div><div class="val" id="c_dept">—</div></div>
        <div class="box"><div class="lbl">فصيلة الدم</div><div class="val ltr" id="c_blood">—</div></div>
        <div class="box full"><div class="lbl">رقم الموظف</div><div class="val ltr" id="c_id">—</div></div>
        <div class="box"><div class="lbl">تاريخ التولد</div><div class="val" id="c_dob">—</div></div>
        <div class="box"><div class="lbl">تاريخ الصلاحية</div><div class="val" id="c_exp">—</div></div>
      </div>
    </div>

    <div class="photo-area">
      <div class="photo"><img id="c_photo" alt="Employee Photo"></div>
      <svg id="barcode"></svg>
      <div class="qr-box"><div id="qrcode"></div></div>
    </div>
  </div>
</div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyMxhTUCG7TZtHLBvH05yX2QA8ApHteGg3TQ2Hq3QsGXKHXBrpt5gTFnWbVcBCgH8ZY9Q/exec";

let employees = [];
let currentId = "";
let photoBase64 = "";
let currentPhotoUrl = "";

const qs = id => document.getElementById(id);

function showNotice(msg,type="success"){
  const n = qs("notice");
  n.textContent = msg;
  n.className = "notice " + type;
  n.style.display = "block";
  setTimeout(()=>n.style.display="none",3000);
}

function normalizeImageUrl(url){
  if(!url) return "";
  if(url.includes("drive.google.com/file/d/")){
    const id = url.split("/d/")[1].split("/")[0];
    return "https://drive.google.com/uc?export=view&id=" + id;
  }
  return url;
}

/* ===== LOAD ===== */
async function loadEmployees(){
  const r = await fetch(API_URL);
  const j = await r.json();
  employees = j.data || [];
  qs("empSelect").innerHTML = '<option value="">—</option>';
  employees.forEach((e,i)=>{
    qs("empSelect").innerHTML += `<option value="${i}">${e.id} — ${e.name}</option>`;
  });
}

/* ===== SELECT ===== */
function selectEmployee(){
  const i = qs("empSelect").value;
  if(i===""){ clearForm(); return; }
  const e = employees[i];
  currentId = e.id;
  currentPhotoUrl = e.photo_url || "";

  qs("f_name").value=e.name||"";
  qs("f_job").value=e.job||"";
  qs("f_dept").value=e.department||"";
  qs("f_type").value=e.type||"0";
  qs("f_blood").value=e.blood||"";
  qs("f_dob").value=e.dob||"";
  qs("f_exp").value=e.expiry||"";

  render(e);
}

/* ===== PREVIEW ===== */
function livePreview(){
  render({
    id:currentId||"—",
    name:qs("f_name").value,
    job:qs("f_job").value,
    department:qs("f_dept").value,
    blood:qs("f_blood").value,
    dob:qs("f_dob").value,
    expiry:qs("f_exp").value,
    photo_url:currentPhotoUrl
  });
}

function render(e){
  qs("c_name").textContent=e.name||"—";
  qs("c_job").textContent=e.job||"—";
  qs("c_dept").textContent=e.department||"—";
  qs("c_blood").textContent=e.blood||"—";
  qs("c_id").textContent=e.id||"—";
  qs("c_dob").textContent=e.dob||"—";
  qs("c_exp").textContent=e.expiry||"—";

  if(e.id && e.id!=="—"){
    JsBarcode("#barcode",e.id,{displayValue:false});
    qs("qrcode").innerHTML="";
    new QRCode(qs("qrcode"),{text:"https://almaraseel.com/emp/"+e.id,width:60,height:60});
  }

  if(e.photo_url){
    qs("c_photo").src=normalizeImageUrl(e.photo_url);
    qs("c_photo").style.display="block";
  }else{
    qs("c_photo").style.display="none";
  }
}

/* ===== PHOTO ===== */
function loadPhoto(ev){
  const r=new FileReader();
  r.onload=()=>{
    photoBase64=r.result;
    currentPhotoUrl="";
    qs("c_photo").src=r.result;
    qs("c_photo").style.display="block";
  };
  r.readAsDataURL(ev.target.files[0]);
}

/* ===== API ===== */
async function api(action, data){
  const params = new URLSearchParams();
  params.append("action", action);

  Object.keys(data).forEach(k => {
    if(data[k] !== undefined && data[k] !== null){
      params.append(k, data[k]);
    }
  });

  const res = await fetch(API_URL, {
    method: "POST",
    body: params
  });

  const json = await res.json();
  if(!json.ok){
    console.error(json);
    throw new Error("API ERROR");
  }
  return json;
}


async function addEmployee(){
  await api("create",{
    name:qs("f_name").value,
    job:qs("f_job").value,
    department:qs("f_dept").value,
    blood:qs("f_blood").value,
    dob:qs("f_dob").value,
    expiry:qs("f_exp").value,
    type:qs("f_type").value,
    photo_base64:photoBase64||""
  });
  clearForm();
  photoBase64="";
  await loadEmployees();
  showNotice("تمت إضافة الموظف بنجاح");
}

async function updateEmployee(){
  if(!currentId){showNotice("اختر موظفًا أولاً","error");return;}
  await api("update",{
    id:currentId,
    name:qs("f_name").value,
    job:qs("f_job").value,
    department:qs("f_dept").value,
    blood:qs("f_blood").value,
    dob:qs("f_dob").value,
    expiry:qs("f_exp").value,
    type:qs("f_type").value,
    photo_base64:photoBase64||""
  });
  photoBase64="";
  await loadEmployees();
  showNotice("تم تحديث البيانات");
}

function clearForm(){
  currentId="";
  currentPhotoUrl="";
  ["f_name","f_job","f_dept","f_dob","f_exp"].forEach(id=>qs(id).value="");
  qs("f_type").value="0";
  qs("f_blood").value="";
  render({});
}

loadEmployees();
</script>
</body>
</html>


